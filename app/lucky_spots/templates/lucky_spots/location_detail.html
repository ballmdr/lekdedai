{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .mini-map {
        height: 300px;
        border-radius: 8px;
    }
    .gallery-image {
        cursor: pointer;
        transition: transform 0.3s;
    }
    .gallery-image:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-600 mb-6">
        <a href="{% url 'home' %}" class="hover:text-purple-600">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
        <span class="mx-2">></span>
        <a href="{% url 'lucky_spots:map' %}" class="hover:text-purple-600">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î</a>
        <span class="mx-2">></span>
        <span class="text-gray-900">{{ location.name }}</span>
    </nav>

    <!-- Header -->
    <div class="gradient-bg text-white rounded-lg p-8 mb-8 text-center relative">
        {% if user.is_staff %}
        <div class="absolute top-4 right-4">
            <a href="/admin/lucky_spots/luckylocation/{{ location.id }}/change/" 
               class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-colors inline-flex items-center gap-2"
               title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">
                <i class="fas fa-edit"></i>
                <span class="hidden sm:inline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
            </a>
        </div>
        {% endif %}
        
        <h1 class="text-3xl md:text-4xl font-bold mb-2">{{ location.name }}</h1>
        <p class="text-lg opacity-90">
            üìç {{ location.province.name }} ‚Ä¢ {{ location.category.get_name_display }}
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Main Image -->
            {% if location.main_image %}
            <img src="{{ location.main_image.url }}" alt="{{ location.name }}" 
                 class="w-full h-80 object-cover rounded-lg shadow-lg mb-6" />
            {% endif %}
            
            <!-- Lucky Numbers -->
            {% if lucky_numbers_list %}
            <div class="lucky-number text-white p-6 rounded-lg text-center mb-6">
                <h3 class="text-xl font-bold mb-4">üçÄ ‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏Ñ</h3>
                <div class="flex flex-wrap justify-center gap-3">
                    {% for number in lucky_numbers_list %}
                    <span class="bg-white bg-opacity-20 px-4 py-2 rounded-full font-bold text-lg">{{ number }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Description -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤</h3>
                <div class="text-gray-700 leading-relaxed">{{ location.description|linebreaks }}</div>
                
                {% if location.highlights %}
                <hr class="my-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">‚ú® ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h4>
                <div class="text-gray-700">{{ location.highlights|linebreaks }}</div>
                {% endif %}
                
                {% if location.address %}
                <hr class="my-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</h4>
                <div class="text-gray-700">{{ location.address }}</div>
                {% endif %}
            </div>
            
            <!-- Gallery -->
            {% if location.gallery_images.all %}
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">üñºÔ∏è ‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {% for image in location.gallery_images.all %}
                    <img src="{{ image.image.url }}" alt="{{ image.caption }}" 
                         class="gallery-image w-full h-32 object-cover rounded-lg shadow" 
                         title="{{ image.caption }}" />
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Comments Section -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</h3>
                
                <!-- Comment Form -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h5 class="font-semibold mb-4">‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
                    <form method="post" action="{% url 'lucky_spots:add_comment' location.slug %}">
                        {% csrf_token %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ *" required
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                            <input type="email" name="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                        </div>
                        <input type="text" name="lucky_number" placeholder="‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô 123, 456)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent mb-4" />
                        <textarea name="comment" rows="4" placeholder="‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." required
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent mb-4"></textarea>
                        <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            ‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
                        </button>
                        <p class="text-sm text-gray-500 mt-2">
                            * ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                        </p>
                    </form>
                </div>
                
                <!-- Comments List -->
                {% if comments %}
                <div>
                    <h5 class="font-semibold mb-4">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°</h5>
                    {% for comment in comments %}
                    <div class="bg-white border-l-4 border-purple-500 p-4 mb-4 rounded-r-lg shadow-sm">
                        <div class="font-semibold text-gray-800">{{ comment.get_author_name }}</div>
                        <div class="text-sm text-gray-500 mb-2">{{ comment.created_at|date:"d/m/Y H:i" }}</div>
                        <div class="text-gray-700">{{ comment.comment|linebreaks }}</div>
                        {% if comment.lucky_number_shared %}
                        <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm mt-2">
                            üçÄ ‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î: {{ comment.lucky_number_shared }}
                        </span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 mt-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå!</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600">{{ location.views_count }}</div>
                    <div class="text-sm text-gray-600">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°</div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600">{{ comments.count }}</div>
                    <div class="text-sm text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</div>
                </div>
            </div>
            
            <!-- Mini Map -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h5 class="font-semibold mb-4">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</h5>
                <div id="mini-map" class="mini-map"></div>
                <div class="mt-4 text-center">
                    <a href="https://maps.google.com/?q={{ location.latitude }},{{ location.longitude }}" 
                       target="_blank" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ Google Maps
                    </a>
                </div>
            </div>
            
            <!-- Related News -->
            {% if related_news %}
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h5 class="font-semibold mb-4">üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h5>
                {% for news in related_news %}
                <div class="border-l-4 border-red-500 pl-4 mb-4">
                    <a href="{{ news.get_absolute_url }}" class="text-gray-800 hover:text-purple-600 transition-colors">
                        <h6 class="font-medium">{{ news.title }}</h6>
                    </a>
                    <small class="text-gray-500">{{ news.created_at|date:"d/m/Y" }}</small>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Nearby Locations -->
            {% if nearby_locations %}
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h5 class="font-semibold mb-4">üó∫Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</h5>
                <div class="space-y-4">
                    {% for nearby in nearby_locations %}
                    <a href="{{ nearby.get_absolute_url }}" class="block hover:bg-gray-50 p-3 rounded-lg transition-colors">
                        <div class="flex items-center space-x-3">
                            {% if nearby.main_image %}
                            <img src="{{ nearby.main_image.url }}" alt="{{ nearby.name }}" 
                                 class="w-16 h-16 object-cover rounded-lg" />
                            {% else %}
                            <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                <span class="text-gray-400">üìç</span>
                            </div>
                            {% endif %}
                            <div>
                                <h6 class="font-medium text-gray-800">{{ nearby.name }}</h6>
                                <small class="text-gray-500">{{ nearby.province.name }}</small>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Initialize mini map
document.addEventListener('DOMContentLoaded', function() {
    const miniMap = L.map('mini-map').setView([{{ location.latitude }}, {{ location.longitude }}], 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(miniMap);
    
    // Add marker
    L.marker([{{ location.latitude }}, {{ location.longitude }}])
        .addTo(miniMap)
        .bindPopup('{{ location.name }}')
        .openPopup();
        
    // Gallery lightbox functionality
    document.querySelectorAll('.gallery-image').forEach(img => {
        img.addEventListener('click', function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 cursor-pointer';
            
            const modalImg = document.createElement('img');
            modalImg.src = this.src;
            modalImg.className = 'max-w-90vw max-h-90vh object-contain';
            
            modal.appendChild(modalImg);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        });
    });
});
</script>
{% endblock %}