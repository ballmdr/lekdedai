{% extends "base.html" %}
{% load static %}

{% block title %}ประวัติการทำนาย AI Ensemble - LekDedAI{% endblock %}

{% block content %}
<!-- Header Section -->
<section class="py-8 bg-gradient-to-br from-primary/10 via-background to-secondary/10">
  <div class="container mx-auto px-4">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-serif font-bold text-foreground mb-2">
        <i class="fas fa-history text-primary mr-2"></i>
        ประวัติการทำนาย AI Ensemble
      </h1>
      <p class="text-lg text-muted-foreground">
        ประวัติการทำนายทั้งหมดของระบบ AI Ensemble
      </p>
    </div>
  </div>
</section>

<div class="container mx-auto px-4 py-8">
  <!-- Filters -->
  <div class="card mb-8">
    <div class="p-6">
      <form method="get" class="flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-48">
          <label class="text-sm font-medium text-foreground mb-1 block">วันที่เริ่มต้น</label>
          <input type="date" name="from" value="{{ date_from }}" class="input w-full">
        </div>
        <div class="flex-1 min-w-48">
          <label class="text-sm font-medium text-foreground mb-1 block">วันที่สิ้นสุด</label>
          <input type="date" name="to" value="{{ date_to }}" class="input w-full">
        </div>
        <div class="flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-filter mr-2"></i>
            กรอง
          </button>
          <a href="{% url 'ai_engine:ensemble_history' %}" class="btn btn-outline">
            <i class="fas fa-times mr-2"></i>
            ล้าง
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Predictions List -->
  {% if predictions %}
  <div class="space-y-4">
    {% for prediction in predictions %}
    <div class="card hover:shadow-lg transition-shadow">
      <div class="p-6">
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <h3 class="text-xl font-semibold text-foreground mb-2">
              งวดวันที่ {{ prediction.session.for_draw_date|date:"j F Y" }}
            </h3>
            <div class="flex items-center gap-4 text-sm text-muted-foreground mb-3">
              <span class="inline-flex items-center gap-1">
                <i class="fas fa-calendar"></i>
                ทำนายเมื่อ: {{ prediction.prediction_timestamp|date:"j/m/Y H:i" }}
              </span>
              <span class="inline-flex items-center gap-1">
                <i class="fas fa-database"></i>
                ข้อมูล: {{ prediction.total_data_points|default:0 }} รายการ
              </span>
              <span class="inline-flex items-center gap-1 
                {% if prediction.session.status == 'completed' %}text-green-600
                {% elif prediction.session.status == 'locked' %}text-orange-600
                {% elif prediction.session.status == 'failed' %}text-red-600
                {% else %}text-gray-600{% endif %}">
                <i class="fas fa-circle text-xs"></i>
                {{ prediction.session.get_status_display }}
              </span>
            </div>
          </div>
          
          <div class="text-right">
            <div class="text-2xl font-bold text-primary mb-1">
              {{ prediction.overall_confidence|floatformat:1 }}%
            </div>
            <div class="text-sm text-muted-foreground">ความมั่นใจ</div>
          </div>
        </div>

        <!-- Prediction Numbers -->
        <div class="grid md:grid-cols-2 gap-6 mb-4">
          <!-- Two Digit Numbers -->
          {% if prediction.final_two_digit %}
          <div>
            <h4 class="font-semibold text-foreground mb-3 flex items-center gap-2">
              <i class="fas fa-dice-two text-primary"></i>
              เลขท้าย 2 ตัว
            </h4>
            <div class="flex flex-wrap gap-2">
              {% for item in prediction.get_top_two_digit_numbers|slice:":5" %}
              <div class="flex items-center gap-2 px-3 py-2 bg-primary/10 rounded-lg">
                <span class="font-bold text-primary font-mono">{{ item.number }}</span>
                <span class="text-xs text-muted-foreground">({{ item.confidence|floatformat:0 }}%)</span>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Three Digit Numbers -->
          {% if prediction.final_three_digit %}
          <div>
            <h4 class="font-semibold text-foreground mb-3 flex items-center gap-2">
              <i class="fas fa-dice-three text-secondary"></i>
              เลขท้าย 3 ตัว
            </h4>
            <div class="flex flex-wrap gap-2">
              {% for item in prediction.get_top_three_digit_numbers|slice:":5" %}
              <div class="flex items-center gap-2 px-3 py-2 bg-secondary/10 rounded-lg">
                <span class="font-bold text-secondary font-mono">{{ item.number }}</span>
                <span class="text-xs text-muted-foreground">({{ item.confidence|floatformat:0 }}%)</span>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Model Contributions -->
        {% if prediction.model_contributions %}
        <div class="border-t border-border pt-4 mb-4">
          <h4 class="font-semibold text-foreground mb-3">การมีส่วนร่วมของโมเดล</h4>
          <div class="flex flex-wrap gap-3">
            {% for model_name, contribution in prediction.model_contributions.items %}
            <div class="flex items-center gap-2 px-3 py-1 bg-muted/30 rounded-full">
              {% if model_name == 'Journalist AI' %}
                <i class="fas fa-newspaper text-blue-500 text-sm"></i>
              {% elif model_name == 'Dream Interpreter AI' %}
                <i class="fas fa-moon text-purple-500 text-sm"></i>
              {% elif model_name == 'Statistical Trend AI' %}
                <i class="fas fa-chart-line text-green-500 text-sm"></i>
              {% else %}
                <i class="fas fa-robot text-gray-500 text-sm"></i>
              {% endif %}
              <span class="text-sm text-foreground">{{ model_name }}</span>
              <span class="text-xs font-bold text-primary">{{ contribution.weight|floatformat:1 }}%</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Summary and Actions -->
        <div class="flex items-center justify-between">
          <div class="flex-1">
            {% if prediction.prediction_summary %}
            <p class="text-sm text-foreground">
              {{ prediction.prediction_summary|truncatechars:120 }}
            </p>
            {% endif %}
          </div>
          <div class="ml-4">
            <a href="{% url 'ai_engine:ensemble_prediction_detail' prediction.id %}" 
               class="btn btn-outline btn-sm">
              <i class="fas fa-eye mr-1"></i>
              ดูรายละเอียด
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Pagination -->
  {% if is_paginated %}
  <div class="flex justify-center mt-8">
    <nav class="flex items-center gap-2">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}{% if date_from %}&from={{ date_from }}{% endif %}{% if date_to %}&to={{ date_to }}{% endif %}" 
         class="btn btn-outline btn-sm">
        <i class="fas fa-chevron-left"></i>
      </a>
      {% endif %}
      
      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <span class="btn btn-primary btn-sm">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <a href="?page={{ num }}{% if date_from %}&from={{ date_from }}{% endif %}{% if date_to %}&to={{ date_to }}{% endif %}" 
           class="btn btn-outline btn-sm">{{ num }}</a>
        {% endif %}
      {% endfor %}
      
      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if date_from %}&from={{ date_from }}{% endif %}{% if date_to %}&to={{ date_to }}{% endif %}" 
         class="btn btn-outline btn-sm">
        <i class="fas fa-chevron-right"></i>
      </a>
      {% endif %}
    </nav>
  </div>
  {% endif %}

  {% else %}
  <!-- Empty State -->
  <div class="card">
    <div class="p-12 text-center">
      <i class="fas fa-history text-4xl text-muted-foreground mb-4"></i>
      <h3 class="text-xl font-semibold text-foreground mb-2">ไม่พบประวัติการทำนาย</h3>
      <p class="text-muted-foreground mb-6">
        {% if date_from or date_to %}
          ไม่พบการทำนายในช่วงเวลาที่ระบุ
        {% else %}
          ยังไม่มีการทำนายด้วย AI Ensemble
        {% endif %}
      </p>
      <div class="flex justify-center gap-3">
        <a href="{% url 'ai_engine:prediction' %}" class="btn btn-primary">
          <i class="fas fa-plus mr-2"></i>
          สร้างการทำนายใหม่
        </a>
        {% if date_from or date_to %}
        <a href="{% url 'ai_engine:ensemble_history' %}" class="btn btn-outline">
          <i class="fas fa-list mr-2"></i>
          ดูทั้งหมด
        </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Action Buttons -->
  <div class="flex justify-center mt-8 gap-4">
    <a href="{% url 'ai_engine:prediction' %}" class="btn btn-primary">
      <i class="fas fa-arrow-left mr-2"></i>
      กลับหน้าหลัก
    </a>
    <a href="{% url 'ai_engine:data_sources' %}" class="btn btn-secondary">
      <i class="fas fa-database mr-2"></i>
      ดูแหล่งข้อมูล
    </a>
    <a href="{% url 'ai_engine:dashboard' %}" class="btn btn-outline">
      <i class="fas fa-tachometer-alt mr-2"></i>
      แดชบอร์ด
    </a>
  </div>
</div>
{% endblock %}